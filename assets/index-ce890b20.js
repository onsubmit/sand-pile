var q=Object.defineProperty;var $=(i,e,t)=>e in i?q(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var a=(i,e,t)=>($(i,typeof e!="symbol"?e+"":e,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const f of n.addedNodes)f.tagName==="LINK"&&f.rel==="modulepreload"&&r(f)}).observe(document,{childList:!0,subtree:!0});function t(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function r(s){if(s.ep)return;s.ep=!0;const n=t(s);fetch(s.href,n)}})();const U=(i,e,t)=>{const r=Math.floor(i.red+(e.red-i.red)*t),s=Math.floor(i.green+(e.green-i.green)*t),n=Math.floor(i.blue+(e.blue-i.blue)*t);return{color:F(r,s,n),accessibleColor:B({red:r,green:s,blue:n})}};function B(i){return Math.round((i.red*299+i.green*587+i.blue*114)/1e3)>128?"black":"white"}const V=i=>{const e=i.substring(1,3),t=i.substring(3,5),r=i.substring(5,7);return{red:parseInt(e,16),green:parseInt(t,16),blue:parseInt(r,16)}};function p(i){var e=i.toString(16);return e.length===1?`0${e}`:e}function F(i,e,t){return`#${p(i)}${p(e)}${p(t)}`}const l=class l{constructor(e){a(this,"_radius");a(this,"_cellSize");a(this,"_cellColor");a(this,"_cellBackgroundColor");a(this,"_drawNumbers");a(this,"_maxStackSize");a(this,"_frameDelay");a(this,"_hideControlsWhenRunning");this._radius=Math.max(l.MIN_RADIUS,parseInt(e.radius||"0")||l.MIN_RADIUS),this._cellSize=Math.max(l.MIN_CELL_SIZE,parseInt(e.cellSize||"0",10)||l.DEFAULT_CELL_SIZE),this._cellColor=e.cellColor||l.DEFAULT_CELL_COLOR,this._cellBackgroundColor=e.cellBackgroundColor||l.DEFAULT_CELL_BACKGROUND_COLOR,this._drawNumbers=e.drawNumbers==="1",this._maxStackSize=Math.max(l.MAX_STACK_SIZE,Math.min(255,parseInt(e.maxStackSize||"0")||l.MAX_STACK_SIZE)),this._frameDelay=Math.max(l.MIN_FRAME_DELAY,parseInt(e.frameDelay||"0")||l.MIN_FRAME_DELAY),this._hideControlsWhenRunning=e.hideControlsWhenRunning==="1",this._cellColor&&!this._cellColor.startsWith("#")&&(this._cellColor=`#${this._cellColor}`)}get radius(){return this._radius}get cellSize(){return this._cellSize}get cellColor(){return this._cellColor}get cellBackgroundColor(){return this._cellBackgroundColor}get drawNumbers(){return this._drawNumbers}get maxStackSize(){return this._maxStackSize}get frameDelay(){return this._frameDelay}get hideControlsWhenRunning(){return this._hideControlsWhenRunning}};a(l,"MIN_RADIUS",2),a(l,"MIN_CELL_SIZE",3),a(l,"DEFAULT_CELL_SIZE",50),a(l,"DEFAULT_CELL_COLOR","#ffffff"),a(l,"DEFAULT_CELL_BACKGROUND_COLOR","#242424"),a(l,"MAX_STACK_SIZE",4),a(l,"MIN_FRAME_DELAY",0);let b=l;const G=(i,e)=>{const t=i*i;return(r,s)=>r*r+s*s<t?e:0};class W{constructor(e,t){a(this,"_grid");a(this,"_defaultValue");a(this,"_radius");a(this,"get",(e,t)=>{var r;return(r=this._grid.get(e))==null?void 0:r.get(t)});a(this,"getOrThrow",(e,t)=>{const r=this._grid.get(e);if(!r)throw new Error(`Invalid row: ${e}`);const s=r.get(t);if(s===void 0)throw new Error(`Invalid column: ${t}`);return s});a(this,"getMaybeExpand",(e,t)=>{if(e<-this._radius-1||e>this._radius+1)throw new Error("The grid can only be expanded one column at a time.");if(t<-this._radius-1||t>this._radius+1)throw new Error("The grid can only be expanded one row at a time.");let r=Math.abs(e)>this._radius||Math.abs(t)>this._radius;return r&&this.expandGrid(),{value:this.getOrThrow(e,t),didExpand:r}});a(this,"set",(e,t,r)=>{var s;(s=this._grid.get(e))==null||s.set(t,r)});a(this,"setOrThrow",(e,t,r)=>{const s=this._grid.get(e);if(!s)throw new Error(`Invalid row: ${e}`);s.set(t,r)});a(this,"setMaybeExpand",(e,t,r)=>{if(e<-this._radius-1||e>this._radius+1)throw new Error("The grid can only be expanded one column at a time.");if(t<-this._radius-1||t>this._radius+1)throw new Error("The grid can only be expanded one row at a time.");let s=Math.abs(e)>this._radius||Math.abs(t)>this._radius;return s&&this.expandGrid(),this.set(e,t,r),s});a(this,"expandGrid",()=>{this._radius+=1;for(const e of[-this._radius,this._radius]){const t=new Map;for(let r=-this._radius;r<=this._radius;r++)t.set(r,this._defaultValue);this._grid.set(e,t)}for(const e of[-this._radius,this._radius])for(let t=-this._radius;t<this._radius;t++)this.set(t,e,this._defaultValue)});this._defaultValue=t,this._radius=e,this._grid=new Map;for(let r=-e;r<=e;r++){const s=new Map;for(let n=-e;n<=e;n++)s.set(n,this._defaultValue);this._grid.set(r,s)}}get radius(){return this._radius}}const C=class C{constructor(e,t,r,s){a(this,"_grid");a(this,"_maxValue");a(this,"_drawCallback");a(this,"_expandCallback");a(this,"drawExample",e=>{for(let t=-this.radius;t<=this.radius;t++)for(let r=-this.radius;r<=this.radius;r++){const s=e(t,r);this.setValueOrThrow(t,r,s)}});a(this,"decrementOrThrow",(e,t,r=1)=>{const s=this.getValueOrThrow(e,t);if(s===0)return 0;const n=s-r;return this._grid.setOrThrow(e,t,n),this._drawCallback(e,t,n),n});a(this,"incrementMaybeExpand",(e,t)=>{const{value:r,didExpand:s}=this.getValueMaybeExpand(e,t),n=r+1;return this.setValueMaybeExpand(e,t,n),s&&this._expandCallback(this.radius),n});a(this,"incrementOrThrow",(e,t,r=1)=>{const s=this.getValueOrThrow(e,t);if(s===this._maxValue)return this._maxValue;const n=s+r;return this._grid.setOrThrow(e,t,n),this._drawCallback(e,t,n),n});a(this,"avalancheOnce",()=>{for(let e=-this.radius;e<=this.radius;e++)for(let t=-this.radius;t<=this.radius;t++)if(this.getValueOrThrow(e,t)>=this._maxValue){this.avalancheAtCoordinate(e,t);return}});a(this,"avalancheOnceOverGrid",()=>{const e=[];for(let t=-this.radius;t<=this.radius;t++)for(let r=-this.radius;r<=this.radius;r++)this.getValueOrThrow(t,r)>=this._maxValue&&e.push({row:t,column:r});for(const{row:t,column:r}of e)this.avalancheAtCoordinate(t,r);return e.length>0});a(this,"startAvalanche",()=>{let e=new Set;for(let t=-this.radius;t<=this.radius;t++)for(let r=-this.radius;r<=this.radius;r++)!e.has(`${t},${r}`)&&this.getValueOrThrow(t,r)>=this._maxValue&&(e=new Set([...e,...this.avalancheAtCoordinate(t,r)]));for(;e.size;)e=this.avalancheAtCoordinates(e)});a(this,"avalancheAtCoordinate",(e,t)=>{const r=[[e-1,t],[e,t+1],[e+1,t],[e,t-1]];let s=new Set;for(const n of r){const[f,_]=n,L=this.incrementMaybeExpand(f,_);L!==void 0&&(this.decrementOrThrow(e,t),L>=this._maxValue&&s.add(`${f},${_}`))}return s});a(this,"avalancheAtCoordinates",e=>{let t=new Set;const r=[...e].map(s=>{const n=s.split(","),f=parseInt(n[0],10),_=parseInt(n[1],10);return{row:f,column:_}});for(const{row:s,column:n}of r)t=new Set([...t,...this.avalancheAtCoordinate(s,n)]);return t});a(this,"topple",(e,t)=>{this.reset(e,t);for(const r of C.directions){const s=e+r[0],n=t+r[1];this.incrementMaybeExpand(s,n)}});a(this,"reset",(e,t)=>{this.setValueOrThrow(e,t,0)});a(this,"getValueOrThrow",(e,t)=>this._grid.getOrThrow(e,t));a(this,"getValueMaybeExpand",(e,t)=>this._grid.getMaybeExpand(e,t));a(this,"setValueMaybeExpand",(e,t,r)=>{const s=this._grid.setMaybeExpand(e,t,r);this._drawCallback(e,t,r),s&&this._expandCallback(this.radius)});a(this,"setValueOrThrow",(e,t,r)=>{this._grid.setOrThrow(e,t,r),this._drawCallback(e,t,r)});this._grid=new W(e,0),this._maxValue=t,this._drawCallback=r,this._expandCallback=s}get radius(){return this._grid.radius}get maxValue(){return this._maxValue}};a(C,"directions",[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,-1]]);let x=C;const Z=new URLSearchParams(window.location.search),K=Object.fromEntries(Z),c=new b(K),P=V(c.cellColor),X=V(c.cellBackgroundColor),h=document.querySelector("#canvas"),I=document.querySelector(".controls"),S=document.querySelector("#start"),m=document.querySelector("#stop"),O=document.querySelector("#stepOnce"),A=document.querySelector("#stepAll"),R=document.querySelector(".examples"),Y=document.querySelector("#exampleCircle"),u=h.getContext("2d");if(!u)throw"Could not get rendering context";let v=!1;const o=c.cellSize,k=1+2*c.radius;h.width=o*k;h.height=o*k;u.fillStyle=c.cellColor;u.font=`${o/4}px arial`;const D=(i,e,t)=>{const r=U(X,P,Math.min(t,c.maxStackSize)/c.maxStackSize);u.fillStyle=r.color;const{x:s,y:n}=j(i,e);u.fillRect(s,n,o,o),c.drawNumbers&&t&&(u.fillStyle=r.accessibleColor,u.fillText(`${t}`,s+4,n+o-4))},H=i=>{h.width=o*(1+2*i),h.height=o*(1+2*i),u.clearRect(0,0,h.width,h.height);for(let e=-i;e<=i;e++)for(let t=-i;t<=i;t++)D(e,t,d.getValueOrThrow(e,t))},d=new x(c.radius,c.maxStackSize,D,H),N=(i,e)=>{const{radius:t}=d,r=-t+e/o,s=-t+i/o;return{row:r,column:s}},j=(i,e)=>{const{radius:t}=d,r=(t+e)*o,s=(t+i)*o;return{x:r,y:s}},w=(i,e,t,r=!1)=>{if(o>1&&(i=Math.floor(i/o)*o),o>1&&(e=Math.floor(e/o)*o),!r&&i===g.x&&e===g.y)return;g.x=i,g.y=e;const{row:s,column:n}=N(i,e);t&&d.getValueOrThrow(s,n)>=c.maxStackSize||(t?d.incrementOrThrow(s,n):d.decrementOrThrow(s,n))},z=(i,e)=>{o>1&&(i=Math.floor(i/o)*o),o>1&&(e=Math.floor(e/o)*o);const{row:t,column:r}=N(i,e);d.reset(t,r),u.fillStyle=c.cellBackgroundColor,u.fillRect(i,e,o,o)};let T=!1,E=!1,y=!1;const g={x:void 0,y:void 0};h.onmousedown=i=>{T=!0,E=i.button===1,y=i.button===2;const{offsetX:e,offsetY:t}=i;y?z(e,t):E?w(e,t,!1,!0):w(e,t,!0,!0)};h.onmouseup=()=>{T=!1};h.onmousemove=i=>{if(T){const{offsetX:e,offsetY:t}=i;y?z(e,t):E?w(e,t,!1):w(e,t,!0)}};h.oncontextmenu=()=>!1;S.onclick=()=>{c.hideControlsWhenRunning&&(I.style.visibility="hidden",R.style.visibility="hidden"),v=!0,S.disabled=!0,m.disabled=!1,A.disabled=!0,O.disabled=!0,M()};m.onclick=()=>{v=!1,S.disabled=!1,m.disabled=!0,A.disabled=!1,O.disabled=!1};O.onclick=()=>{d.avalancheOnce()};A.onclick=()=>{d.avalancheOnceOverGrid()};Y.onclick=()=>{d.drawExample(G(d.radius,d.maxValue))};const J=()=>{if(!v)return;if(!d.avalancheOnceOverGrid()){c.hideControlsWhenRunning&&(I.style.visibility="visible",R.style.visibility="visible"),m.click();return}c.frameDelay>0?setTimeout(()=>{M()},c.frameDelay):M()},M=()=>{window.requestAnimationFrame(()=>J())};
